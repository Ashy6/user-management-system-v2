# ç”¨æˆ·ç®¡ç†ç³»ç»ŸæŠ€æœ¯æ¶æ„æ–‡æ¡£

## 1. Architecture design

```mermaid
graph TD
  A[User Browser] --> B[React Frontend Application]
  B --> C[Axios HTTP Client]
  C --> D[NestJS Backend API]
  D --> E[PostgreSQL Database]
  D --> F[Email Service]
  D --> G[Redis Cache]

  subgraph "Frontend Layer"
      B
      H[React Router]
      I[TailwindCSS]
      J[ahooks]
  end

  subgraph "Backend Layer"
      D
      K[JWT Authentication]
      L[Swagger Documentation]
      M[TypeORM]
  end

  subgraph "Data Layer"
      E
      G
  end

  subgraph "External Services"
      F
  end
```

## 2. Technology Description

* **Frontend**: React\@19 + TypeScript\@5 + TailwindCSS\@3 + ahooks\@3 + axios\@1 + Vite\@5

* **Backend**: NestJS\@10 + TypeScript\@5 + TypeORM\@0.3 + Swagger\@7

* **Database**: PostgreSQL\@15 + Redis\@7 (ç¼“å­˜)

* **Authentication**: JWT + é‚®ç®±éªŒè¯ç 

* **Email Service**: Nodemailer + SMTP

* **Security**: bcryptå¯†ç åŠ å¯† + helmetå®‰å…¨å¤´ + rate-limiting

## 3. Route definitions

| Route      | Purpose                            |
| ---------- | ---------------------------------- |
| /login     | ç™»å½•é¡µé¢ï¼Œé‚®ç®±éªŒè¯ç ç™»å½•å’Œç”¨æˆ·æ³¨å†Œ |
| /dashboard | é¦–é¡µä»ªè¡¨æ¿ï¼Œç³»ç»Ÿæ¦‚è§ˆå’Œæ•°æ®ç»Ÿè®¡     |
| /users     | ç”¨æˆ·åˆ—è¡¨é¡µé¢ï¼Œç”¨æˆ·ç®¡ç†å’Œæœç´¢åŠŸèƒ½   |
| /users/:id | ç”¨æˆ·è¯¦æƒ…é¡µé¢ï¼Œç”¨æˆ·ä¿¡æ¯ç¼–è¾‘         |
| /settings  | ç³»ç»Ÿè®¾ç½®é¡µé¢ï¼Œç³»ç»Ÿé…ç½®å’Œæƒé™ç®¡ç†   |
| /profile   | ä¸ªäººèµ„æ–™é¡µé¢ï¼Œä¸ªäººä¿¡æ¯ç®¡ç†         |
| /404       | 404é”™è¯¯é¡µé¢                        |

## 4. API definitions

### 4.1 Core API

**ç”¨æˆ·è®¤è¯ç›¸å…³**

```
POST /api/auth/send-code
```

Request:

| Param Name | Param Type | isRequired | Description                       |
| ---------- | ---------- | ---------- | --------------------------------- |
| email      | string     | true       | ç”¨æˆ·é‚®ç®±åœ°å€                      |
| type       | string     | true       | éªŒè¯ç ç±»å‹ (login/register/reset) |

Response:

| Param Name | Param Type | Description        |
| ---------- | ---------- | ------------------ |
| success    | boolean    | å‘é€çŠ¶æ€           |
| message    | string     | å“åº”æ¶ˆæ¯           |
| expireTime | number     | éªŒè¯ç è¿‡æœŸæ—¶é—´(ç§’) |

Example:

```json
{
  "email": "user@yourdomain.com",
  "type": "login"
}
```

```
POST /api/auth/verify-code
```

Request:

| Param Name | Param Type | isRequired | Description  |
| ---------- | ---------- | ---------- | ------------ |
| email      | string     | true       | ç”¨æˆ·é‚®ç®±åœ°å€ |
| code       | string     | true       | éªŒè¯ç        |
| type       | string     | true       | éªŒè¯ç±»å‹     |

Response:

| Param Name   | Param Type | Description |
| ------------ | ---------- | ----------- |
| success      | boolean    | éªŒè¯çŠ¶æ€    |
| token        | string     | JWTè®¿é—®ä»¤ç‰Œ |
| refreshToken | string     | åˆ·æ–°ä»¤ç‰Œ    |
| user         | object     | ç”¨æˆ·ä¿¡æ¯    |

**ç”¨æˆ·ç®¡ç†ç›¸å…³**

```
GET /api/users
```

Query Parameters:

| Param Name | Param Type | isRequired | Description      |
| ---------- | ---------- | ---------- | ---------------- |
| page       | number     | false      | é¡µç ï¼Œé»˜è®¤1      |
| limit      | number     | false      | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10 |
| search     | string     | false      | æœç´¢å…³é”®è¯       |
| status     | string     | false      | ç”¨æˆ·çŠ¶æ€ç­›é€‰     |

Response:

| Param Name | Param Type | Description |
| ---------- | ---------- | ----------- |
| data       | array      | ç”¨æˆ·åˆ—è¡¨    |
| total      | number     | æ€»æ•°é‡      |
| page       | number     | å½“å‰é¡µç     |
| limit      | number     | æ¯é¡µæ•°é‡    |

```
POST /api/users
```

Request:

| Param Name | Param Type | isRequired | Description |
| ---------- | ---------- | ---------- | ----------- |
| email      | string     | true       | é‚®ç®±åœ°å€    |
| name       | string     | true       | ç”¨æˆ·å§“å    |
| role       | string     | false      | ç”¨æˆ·è§’è‰²    |

```
PUT /api/users/:id
```

Request:

| Param Name | Param Type | isRequired | Description |
| ---------- | ---------- | ---------- | ----------- |
| name       | string     | false      | ç”¨æˆ·å§“å    |
| status     | string     | false      | ç”¨æˆ·çŠ¶æ€    |
| role       | string     | false      | ç”¨æˆ·è§’è‰²    |

```
DELETE /api/users/:id
```

**ç³»ç»Ÿè®¾ç½®ç›¸å…³**

```
GET /api/settings
```

Response:

| Param Name     | Param Type | Description  |
| -------------- | ---------- | ------------ |
| emailConfig    | object     | é‚®ä»¶æœåŠ¡é…ç½® |
| securityConfig | object     | å®‰å…¨ç­–ç•¥é…ç½® |
| systemConfig   | object     | ç³»ç»Ÿå‚æ•°é…ç½® |

```
PUT /api/settings
```

Request:

| Param Name     | Param Type | isRequired | Description  |
| -------------- | ---------- | ---------- | ------------ |
| emailConfig    | object     | false      | é‚®ä»¶æœåŠ¡é…ç½® |
| securityConfig | object     | false      | å®‰å…¨ç­–ç•¥é…ç½® |
| systemConfig   | object     | false      | ç³»ç»Ÿå‚æ•°é…ç½® |

## 5. Server architecture diagram

```mermaid
graph TD
  A[Client Request] --> B[Guards & Middleware]
  B --> C[Controller Layer]
  C --> D[Service Layer]
  D --> E[Repository Layer]
  E --> F[(PostgreSQL Database)]
  
  D --> G[Email Service]
  D --> H[(Redis Cache)]
  
  subgraph "NestJS Application"
      B
      C
      D
      E
      I[Exception Filters]
      J[Interceptors]
      K[Pipes & Validation]
  end
  
  subgraph "External Services"
      G
      L[SMTP Server]
  end
```

### 5.1 æ¶æ„å±‚æ¬¡è¯´æ˜

**è¯·æ±‚å¤„ç†æµç¨‹ï¼š**

1. **Guards & Middleware**: èº«ä»½éªŒè¯ã€æƒé™æ£€æŸ¥ã€è¯·æ±‚é¢„å¤„ç†
2. **Controller Layer**: è·¯ç”±å¤„ç†ã€è¯·æ±‚å‚æ•°è§£æã€å“åº”æ ¼å¼åŒ–
3. **Service Layer**: ä¸šåŠ¡é€»è¾‘å¤„ç†ã€æ•°æ®éªŒè¯ã€äº‹åŠ¡ç®¡ç†
4. **Repository Layer**: æ•°æ®è®¿é—®æŠ½è±¡ã€ORMæ“ä½œã€æŸ¥è¯¢ä¼˜åŒ–
5. **Database Layer**: æ•°æ®æŒä¹…åŒ–ã€ç´¢å¼•ä¼˜åŒ–ã€äº‹åŠ¡æ”¯æŒ

**æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼š**

* **Exception Filters**: å…¨å±€å¼‚å¸¸å¤„ç†ã€é”™è¯¯æ—¥å¿—è®°å½•
* **Interceptors**: è¯·æ±‚/å“åº”æ‹¦æˆªã€æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§
* **Pipes & Validation**: æ•°æ®éªŒè¯ã€ç±»å‹è½¬æ¢ã€å‚æ•°æ¸…ç†

## 6. å®‰å…¨æ¶æ„è®¾è®¡

### 6.1 èº«ä»½è®¤è¯æœºåˆ¶

```mermaid
sequenceDiagram
    participant C as Client
    participant A as Auth Service
    participant E as Email Service
    participant R as Redis
    participant D as Database
    
    C->>A: è¯·æ±‚å‘é€éªŒè¯ç 
    A->>E: å‘é€é‚®ä»¶éªŒè¯ç 
    A->>R: ç¼“å­˜éªŒè¯ç (5åˆ†é’Ÿ)
    E-->>C: é‚®ä»¶å‘é€æˆåŠŸ
    
    C->>A: æäº¤éªŒè¯ç ç™»å½•
    A->>R: éªŒè¯ç æ ¡éªŒ
    A->>D: æŸ¥è¯¢/åˆ›å»ºç”¨æˆ·
    A->>A: ç”ŸæˆJWTä»¤ç‰Œ
    A->>R: å­˜å‚¨åˆ·æ–°ä»¤ç‰Œ
    A-->>C: è¿”å›è®¿é—®ä»¤ç‰Œ
```

**å®‰å…¨ç‰¹æ€§ï¼š**

* JWTè®¿é—®ä»¤ç‰Œï¼ˆçŸ­æœŸæœ‰æ•ˆï¼Œ1å°æ—¶ï¼‰
* åˆ·æ–°ä»¤ç‰Œï¼ˆé•¿æœŸæœ‰æ•ˆï¼Œ7å¤©ï¼‰
* éªŒè¯ç é™åˆ¶ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼Œå•æ¬¡ä½¿ç”¨ï¼‰
* IPåœ°å€è®°å½•å’Œå¼‚å¸¸æ£€æµ‹
* ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶

### 6.2 æƒé™æ§åˆ¶ç³»ç»Ÿ

```mermaid
graph LR
    A[ç”¨æˆ·è¯·æ±‚] --> B[JWTéªŒè¯]
    B --> C[è§’è‰²è¯†åˆ«]
    C --> D[æƒé™æ£€æŸ¥]
    D --> E[èµ„æºè®¿é—®]
    
    F[è§’è‰²ç®¡ç†] --> G[æƒé™åˆ†é…]
    G --> H[åŠ¨æ€æƒé™æ›´æ–°]
    
    subgraph "RBACæ¨¡å‹"
        I[ç”¨æˆ·] --> J[è§’è‰²]
        J --> K[æƒé™]
        K --> L[èµ„æº]
    end
```

**æƒé™æ¨¡å‹ï¼š**

* åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
* ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼ˆèµ„æº+æ“ä½œï¼‰
* åŠ¨æ€æƒé™æ›´æ–°
* æƒé™ç»§æ‰¿å’Œç»„åˆ

### 6.3 æ•°æ®å®‰å…¨æªæ–½

* **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®AESåŠ å¯†å­˜å‚¨
* **ä¼ è¾“å®‰å…¨**: HTTPS/TLS 1.3åŠ å¯†ä¼ è¾“
* **SQLæ³¨å…¥é˜²æŠ¤**: TypeORMå‚æ•°åŒ–æŸ¥è¯¢
* **XSSé˜²æŠ¤**: è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç 
* **CSRFé˜²æŠ¤**: CSRFä»¤ç‰ŒéªŒè¯
* **è¯·æ±‚é™åˆ¶**: åŸºäºIPçš„é¢‘ç‡é™åˆ¶

## 7. ç¼“å­˜ç­–ç•¥è®¾è®¡

### 7.1 Redisç¼“å­˜æ¶æ„

```mermaid
graph TD
    A[åº”ç”¨å±‚] --> B[ç¼“å­˜å±‚]
    B --> C[Redis Cluster]
    B --> D[æ•°æ®åº“å±‚]
    
    subgraph "ç¼“å­˜ç­–ç•¥"
        E[éªŒè¯ç ç¼“å­˜]
        F[ç”¨æˆ·ä¼šè¯ç¼“å­˜]
        G[æƒé™ç¼“å­˜]
        H[ç³»ç»Ÿé…ç½®ç¼“å­˜]
    end
    
    C --> E
    C --> F
    C --> G
    C --> H
```

**ç¼“å­˜ç±»å‹å’Œç­–ç•¥ï¼š**

| ç¼“å­˜ç±»å‹   | å­˜å‚¨å†…å®¹     | è¿‡æœŸæ—¶é—´ | æ›´æ–°ç­–ç•¥       |
| ---------- | ------------ | -------- | -------------- |
| éªŒè¯ç ç¼“å­˜ | é‚®ç®±éªŒè¯ç    | 5åˆ†é’Ÿ    | å†™å…¥æ—¶è¿‡æœŸ     |
| ç”¨æˆ·ä¼šè¯   | JWTåˆ·æ–°ä»¤ç‰Œ  | 7å¤©      | æ»‘åŠ¨è¿‡æœŸ       |
| æƒé™ç¼“å­˜   | ç”¨æˆ·æƒé™ä¿¡æ¯ | 30åˆ†é’Ÿ   | æƒé™å˜æ›´æ—¶æ¸…é™¤ |
| ç³»ç»Ÿé…ç½®   | ç³»ç»Ÿè®¾ç½®å‚æ•° | 1å°æ—¶    | é…ç½®æ›´æ–°æ—¶æ¸…é™¤ |
| ç”¨æˆ·ä¿¡æ¯   | åŸºç¡€ç”¨æˆ·æ•°æ® | 15åˆ†é’Ÿ   | ç”¨æˆ·æ›´æ–°æ—¶æ¸…é™¤ |

### 7.2 ç¼“å­˜ä¸€è‡´æ€§ä¿è¯

* **å†™å…¥ç­–ç•¥**: Write-Throughï¼ˆå†™å…¥æ•°æ®åº“åŒæ—¶æ›´æ–°ç¼“å­˜ï¼‰
* **å¤±æ•ˆç­–ç•¥**: æ•°æ®å˜æ›´æ—¶ä¸»åŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
* **é¢„çƒ­ç­–ç•¥**: ç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
* **é™çº§ç­–ç•¥**: ç¼“å­˜ä¸å¯ç”¨æ—¶ç›´æ¥è®¿é—®æ•°æ®åº“

## 8. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 8.1 æ•°æ®åº“ä¼˜åŒ–

**ç´¢å¼•ç­–ç•¥ï¼š**

```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•ä¼˜åŒ–
CREATE INDEX CONCURRENTLY idx_users_email_status ON users(email, status);
CREATE INDEX CONCURRENTLY idx_users_role_created ON users(role_id, created_at DESC);

-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX CONCURRENTLY idx_login_logs_user_time ON login_logs(user_id, created_at DESC);
CREATE INDEX CONCURRENTLY idx_email_codes_email_type_expires ON email_codes(email, type, expires_at);
```

**æŸ¥è¯¢ä¼˜åŒ–ï¼š**

* åˆ†é¡µæŸ¥è¯¢ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
* å¤æ‚æŸ¥è¯¢ä½¿ç”¨ç‰©åŒ–è§†å›¾
* è¯»å†™åˆ†ç¦»ï¼ˆä¸»ä»å¤åˆ¶ï¼‰
* è¿æ¥æ± ä¼˜åŒ–ï¼ˆæœ€å¤§è¿æ¥æ•°ï¼š20ï¼‰

### 8.2 åº”ç”¨å±‚ä¼˜åŒ–

**å¹¶å‘å¤„ç†ï¼š**

* å¼‚æ­¥å¤„ç†é‚®ä»¶å‘é€
* æ•°æ®åº“è¿æ¥æ± ç®¡ç†
* è¯·æ±‚é˜Ÿåˆ—å’Œé™æµ
* æ‰¹é‡æ“ä½œä¼˜åŒ–

**å†…å­˜ä¼˜åŒ–ï¼š**

* å¯¹è±¡æ± å¤ç”¨
* å†…å­˜æ³„æ¼ç›‘æ§
* GCä¼˜åŒ–é…ç½®
* ç¼“å­˜å¤§å°é™åˆ¶

### 8.3 ç½‘ç»œä¼˜åŒ–

* **HTTP/2æ”¯æŒ**: å¤šè·¯å¤ç”¨å’ŒæœåŠ¡å™¨æ¨é€
* **å‹ç¼©ç®—æ³•**: Gzip/Brotliå“åº”å‹ç¼©
* **CDNåŠ é€Ÿ**: é™æ€èµ„æºåˆ†å‘
* **Keep-Alive**: è¿æ¥å¤ç”¨

## 9. ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

### 9.1 æ—¥å¿—æ¶æ„

```mermaid
graph LR
    A[åº”ç”¨æ—¥å¿—] --> B[æ—¥å¿—æ”¶é›†]
    C[è®¿é—®æ—¥å¿—] --> B
    D[é”™è¯¯æ—¥å¿—] --> B
    E[æ€§èƒ½æ—¥å¿—] --> B
    
    B --> F[æ—¥å¿—èšåˆ]
    F --> G[æ—¥å¿—å­˜å‚¨]
    F --> H[å®æ—¶ç›‘æ§]
    F --> I[å‘Šè­¦ç³»ç»Ÿ]
```

**æ—¥å¿—åˆ†ç±»ï¼š**

* **è®¿é—®æ—¥å¿—**: HTTPè¯·æ±‚è®°å½•ã€å“åº”æ—¶é—´ã€çŠ¶æ€ç 
* **ä¸šåŠ¡æ—¥å¿—**: ç”¨æˆ·æ“ä½œã€ä¸šåŠ¡æµç¨‹ã€æ•°æ®å˜æ›´
* **é”™è¯¯æ—¥å¿—**: å¼‚å¸¸å †æ ˆã€é”™è¯¯ä¸Šä¸‹æ–‡ã€æ¢å¤å»ºè®®
* **æ€§èƒ½æ—¥å¿—**: æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ã€ç¼“å­˜å‘½ä¸­ç‡ã€å†…å­˜ä½¿ç”¨

### 9.2 ç›‘æ§æŒ‡æ ‡

**ç³»ç»ŸæŒ‡æ ‡ï¼š**

* CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡
* ç£ç›˜I/Oã€ç½‘ç»œI/O
* æ•°æ®åº“è¿æ¥æ•°ã€æŸ¥è¯¢å“åº”æ—¶é—´
* Redisè¿æ¥æ•°ã€ç¼“å­˜å‘½ä¸­ç‡

**ä¸šåŠ¡æŒ‡æ ‡ï¼š**

* ç”¨æˆ·æ³¨å†Œ/ç™»å½•æˆåŠŸç‡
* éªŒè¯ç å‘é€æˆåŠŸç‡
* APIå“åº”æ—¶é—´åˆ†å¸ƒ
* é”™è¯¯ç‡å’Œå¼‚å¸¸ç»Ÿè®¡

### 9.3 å‘Šè­¦ç­–ç•¥

| å‘Šè­¦çº§åˆ« | è§¦å‘æ¡ä»¶                     | é€šçŸ¥æ–¹å¼       | å“åº”æ—¶é—´ |
| -------- | ---------------------------- | -------------- | -------- |
| ç´§æ€¥     | ç³»ç»Ÿä¸å¯ç”¨ã€æ•°æ®åº“è¿æ¥å¤±è´¥   | çŸ­ä¿¡+é‚®ä»¶+ç”µè¯ | 5åˆ†é’Ÿå†…  |
| é‡è¦     | é”™è¯¯ç‡>5%ã€å“åº”æ—¶é—´>2s       | é‚®ä»¶+å³æ—¶æ¶ˆæ¯  | 15åˆ†é’Ÿå†… |
| è­¦å‘Š     | ç¼“å­˜å‘½ä¸­ç‡<80%ã€ç£ç›˜ä½¿ç”¨>80% | é‚®ä»¶           | 1å°æ—¶å†…  |
| ä¿¡æ¯     | æ–°ç”¨æˆ·æ³¨å†Œã€ç³»ç»Ÿé…ç½®å˜æ›´     | æ—¥å¿—è®°å½•       | æ— éœ€å“åº” |

## 6. Data model

### 6.1 Data model definition

```mermaid
erDiagram
    USERS ||--o{ USER_SESSIONS : has
    USERS ||--o{ EMAIL_CODES : receives
    USERS }|--|| ROLES : assigned
    USERS ||--o{ LOGIN_LOGS : generates
    ROLES ||--o{ PERMISSIONS : contains

    USERS {
        uuid id PK
        string email UK
        string name
        string avatar_url
        string phone
        enum status
        uuid role_id FK
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at
    }
    
    ROLES {
        uuid id PK
        string name UK
        string description
        json permissions
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }
    
    USER_SESSIONS {
        uuid id PK
        uuid user_id FK
        string refresh_token
        string ip_address
        string user_agent
        timestamp expires_at
        timestamp created_at
    }
    
    EMAIL_CODES {
        uuid id PK
        string email
        string code
        enum type
        boolean is_used
        timestamp expires_at
        timestamp created_at
    }
    
    LOGIN_LOGS {
        uuid id PK
        uuid user_id FK
        string ip_address
        string user_agent
        enum status
        timestamp created_at
    }
    
    PERMISSIONS {
        uuid id PK
        string resource
        string action
        string description
        timestamp created_at
    }
```

### 6.2 Data Definition Language

**ç”¨æˆ·è¡¨ (users)**

```sql
-- create table
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    avatar_url TEXT,
    phone VARCHAR(20),
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'suspended')),
    role_id UUID REFERENCES roles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

-- create index
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_role_id ON users(role_id);
CREATE INDEX idx_users_created_at ON users(created_at DESC);
```

**è§’è‰²è¡¨ (roles)**

```sql
-- create table
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    permissions JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- create index
CREATE INDEX idx_roles_name ON roles(name);
CREATE INDEX idx_roles_is_active ON roles(is_active);

-- init data
INSERT INTO roles (name, description, permissions) VALUES
('super_admin', 'è¶…çº§ç®¡ç†å‘˜', '{"users": ["create", "read", "update", "delete"], "system": ["read", "write"], "roles": ["create", "read", "update", "delete"]}'),
('admin', 'ç®¡ç†å‘˜', '{"users": ["create", "read", "update"], "system": ["read"]}'),
('user', 'æ™®é€šç”¨æˆ·', '{"profile": ["read", "update"]}');
```

**ç”¨æˆ·ä¼šè¯è¡¨ (user\_sessions)**

```sql
-- create table
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    refresh_token VARCHAR(500) NOT NULL,
    ip_address INET,
    user_agent TEXT,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- create index
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_refresh_token ON user_sessions(refresh_token);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
```

**é‚®ç®±éªŒè¯ç è¡¨ (email\_codes)**

```sql
-- create table
CREATE TABLE email_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL,
    code VARCHAR(10) NOT NULL,
    type VARCHAR(20) NOT NULL CHECK (type IN ('login', 'register', 'reset')),
    is_used BOOLEAN DEFAULT false,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- create index
CREATE INDEX idx_email_codes_email ON email_codes(email);
CREATE INDEX idx_email_codes_code ON email_codes(code);
CREATE INDEX idx_email_codes_expires_at ON email_codes(expires_at);
CREATE INDEX idx_email_codes_type ON email_codes(type);
```

**ç™»å½•æ—¥å¿—è¡¨ (login\_logs)**

```sql
-- create table
CREATE TABLE login_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    ip_address INET,
    user_agent TEXT,
    status VARCHAR(20) DEFAULT 'success' CHECK (status IN ('success', 'failed', 'blocked')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- create index
CREATE INDEX idx_login_logs_user_id ON login_logs(user_id);
CREATE INDEX idx_login_logs_created_at ON login_logs(created_at DESC);
CREATE INDEX idx_login_logs_status ON login_logs(status);
```

## 10. éƒ¨ç½²æ¶æ„è®¾è®¡

### 10.1 å®¹å™¨åŒ–éƒ¨ç½²

```mermaid
graph TB
    subgraph "Docker Compose éƒ¨ç½²"
        A[Nginx Proxy] --> B[Frontend Container]
        A --> C[Backend Container]
        C --> D[PostgreSQL Container]
        C --> E[Redis Container]
        C --> F[SMTP Service]
    end
    
    subgraph "Kubernetes éƒ¨ç½²"
        G[Ingress Controller] --> H[Frontend Pods]
        G --> I[Backend Pods]
        I --> J[PostgreSQL StatefulSet]
        I --> K[Redis Deployment]
        I --> L[External SMTP]
    end
```

**Docker Compose é…ç½®è¦ç‚¹ï¼š**

* æœåŠ¡éš”ç¦»å’Œç½‘ç»œé…ç½®
* æ•°æ®å·æŒä¹…åŒ–
* ç¯å¢ƒå˜é‡ç®¡ç†
* å¥åº·æ£€æŸ¥é…ç½®
* èµ„æºé™åˆ¶è®¾ç½®

**Kubernetes éƒ¨ç½²ç‰¹æ€§ï¼š**

* è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰
* æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
* é…ç½®å’Œå¯†é’¥ç®¡ç†
* æ»šåŠ¨æ›´æ–°å’Œå›æ»š
* ç›‘æ§å’Œæ—¥å¿—æ”¶é›†

### 10.2 ç”Ÿäº§ç¯å¢ƒæ¶æ„

```mermaid
graph TB
    subgraph "è´Ÿè½½å‡è¡¡å±‚"
        A[Load Balancer]
        B[SSL Termination]
    end
    
    subgraph "åº”ç”¨å±‚"
        C[Frontend Cluster]
        D[Backend Cluster]
    end
    
    subgraph "æ•°æ®å±‚"
        E[PostgreSQL Master]
        F[PostgreSQL Slaves]
        G[Redis Cluster]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        H[SMTP Service]
        I[Monitoring]
        J[Log Aggregation]
    end
    
    A --> B
    B --> C
    B --> D
    D --> E
    D --> F
    D --> G
    D --> H
    D --> I
    D --> J
```

**é«˜å¯ç”¨ç‰¹æ€§ï¼š**

* å¤šå®ä¾‹éƒ¨ç½²ï¼ˆè‡³å°‘2ä¸ªåç«¯å®ä¾‹ï¼‰
* æ•°æ®åº“ä¸»ä»å¤åˆ¶
* Redisé›†ç¾¤æ¨¡å¼
* è‡ªåŠ¨æ•…éšœè½¬ç§»
* å¥åº·æ£€æŸ¥å’Œè‡ªæ„ˆ

### 10.3 ç¯å¢ƒé…ç½®ç®¡ç†

| ç¯å¢ƒ       | é…ç½®ç‰¹ç‚¹           | éƒ¨ç½²æ–¹å¼       | ç›‘æ§çº§åˆ«   |
| ---------- | ------------------ | -------------- | ---------- |
| å¼€å‘ç¯å¢ƒ   | å•å®ä¾‹ã€æœ¬åœ°æ•°æ®åº“ | Docker Compose | åŸºç¡€ç›‘æ§   |
| æµ‹è¯•ç¯å¢ƒ   | æ¨¡æ‹Ÿç”Ÿäº§ã€æµ‹è¯•æ•°æ® | Kubernetes     | å®Œæ•´ç›‘æ§   |
| é¢„ç”Ÿäº§ç¯å¢ƒ | ç”Ÿäº§é…ç½®ã€çœŸå®æ•°æ® | Kubernetes     | ç”Ÿäº§çº§ç›‘æ§ |
| ç”Ÿäº§ç¯å¢ƒ   | é«˜å¯ç”¨ã€æ€§èƒ½ä¼˜åŒ–   | Kubernetes     | å…¨æ–¹ä½ç›‘æ§ |

## 11. å®¹é”™å’Œæ¢å¤æœºåˆ¶

### 11.1 æ•…éšœå¤„ç†ç­–ç•¥

```mermaid
graph TD
    A[æœåŠ¡è¯·æ±‚] --> B{å¥åº·æ£€æŸ¥}
    B -->|æ­£å¸¸| C[æ­£å¸¸å¤„ç†]
    B -->|å¼‚å¸¸| D[æ•…éšœæ£€æµ‹]
    
    D --> E{æ•…éšœç±»å‹}
    E -->|ç½‘ç»œè¶…æ—¶| F[é‡è¯•æœºåˆ¶]
    E -->|æœåŠ¡ä¸å¯ç”¨| G[ç†”æ–­å™¨]
    E -->|æ•°æ®åº“å¼‚å¸¸| H[é™çº§æœåŠ¡]
    
    F --> I[æŒ‡æ•°é€€é¿é‡è¯•]
    G --> J[å¿«é€Ÿå¤±è´¥]
    H --> K[ç¼“å­˜æ•°æ®è¿”å›]
    
    I --> L[æ¢å¤æ£€æµ‹]
    J --> L
    K --> L
    L --> A
```

**å®¹é”™æœºåˆ¶ï¼š**

* **é‡è¯•æœºåˆ¶**: ç½‘ç»œå¼‚å¸¸æ—¶æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
* **ç†”æ–­å™¨**: æœåŠ¡å¼‚å¸¸æ—¶å¿«é€Ÿå¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœ
* **è¶…æ—¶æ§åˆ¶**: è®¾ç½®åˆç†çš„è¯·æ±‚è¶…æ—¶æ—¶é—´
* **é™çº§æœåŠ¡**: æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨æ—¶æä¾›åŸºç¡€æœåŠ¡
* **é™æµä¿æŠ¤**: é˜²æ­¢ç³»ç»Ÿè¿‡è½½

### 11.2 æ•°æ®å¤‡ä»½å’Œæ¢å¤

**å¤‡ä»½ç­–ç•¥ï¼š**

```bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/postgresql"

# å…¨é‡å¤‡ä»½ï¼ˆæ¯æ—¥ï¼‰
pg_dump -h localhost -U postgres -d user_management > $BACKUP_DIR/full_backup_$DATE.sql

# å¢é‡å¤‡ä»½ï¼ˆæ¯å°æ—¶ï¼‰
pg_basebackup -h localhost -U postgres -D $BACKUP_DIR/incremental_$DATE -Ft -z

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
```

**æ¢å¤æµç¨‹ï¼š**

1. åœæ­¢åº”ç”¨æœåŠ¡
2. æ¢å¤æ•°æ®åº“å¤‡ä»½
3. éªŒè¯æ•°æ®å®Œæ•´æ€§
4. é‡å¯åº”ç”¨æœåŠ¡
5. åŠŸèƒ½éªŒè¯æµ‹è¯•

### 11.3 ç¾éš¾æ¢å¤è®¡åˆ’

| æ•…éšœçº§åˆ«   | æ¢å¤æ—¶é—´ç›®æ ‡(RTO) | æ¢å¤ç‚¹ç›®æ ‡(RPO) | æ¢å¤ç­–ç•¥      |
| ---------- | ----------------- | --------------- | ------------- |
| åº”ç”¨æ•…éšœ   | 5åˆ†é’Ÿ             | 0               | è‡ªåŠ¨é‡å¯/åˆ‡æ¢ |
| æ•°æ®åº“æ•…éšœ | 15åˆ†é’Ÿ            | 1å°æ—¶           | ä¸»ä»åˆ‡æ¢      |
| æœºæˆ¿æ•…éšœ   | 2å°æ—¶             | 4å°æ—¶           | å¼‚åœ°å¤‡ä»½æ¢å¤  |
| å®Œå…¨ç¾éš¾   | 24å°æ—¶            | 24å°æ—¶          | å®Œæ•´ç³»ç»Ÿé‡å»º  |

## 12. æ‰©å±•æ€§è®¾è®¡

### 12.1 æ°´å¹³æ‰©å±•ç­–ç•¥

```mermaid
graph LR
    subgraph "åº”ç”¨å±‚æ‰©å±•"
        A[Load Balancer] --> B[App Instance 1]
        A --> C[App Instance 2]
        A --> D[App Instance N]
    end
    
    subgraph "æ•°æ®å±‚æ‰©å±•"
        E[Write DB] --> F[Read Replica 1]
        E --> G[Read Replica 2]
        H[Redis Cluster] --> I[Redis Node 1]
        H --> J[Redis Node 2]
        H --> K[Redis Node N]
    end
    
    B --> E
    C --> E
    D --> E
    B --> F
    C --> G
    D --> H
```

**æ‰©å±•èƒ½åŠ›ï¼š**

* **æ— çŠ¶æ€åº”ç”¨**: æ”¯æŒä»»æ„æ•°é‡çš„åº”ç”¨å®ä¾‹
* **æ•°æ®åº“è¯»å†™åˆ†ç¦»**: è¯»æ“ä½œåˆ†æ•£åˆ°å¤šä¸ªä»åº“
* **ç¼“å­˜é›†ç¾¤**: Redisé›†ç¾¤æ”¯æŒæ•°æ®åˆ†ç‰‡
* **CDNåŠ é€Ÿ**: é™æ€èµ„æºå…¨çƒåˆ†å‘

### 12.2 å‚ç›´æ‰©å±•ä¼˜åŒ–

**èµ„æºé…ç½®å»ºè®®ï¼š**

| ç»„ä»¶     | CPU   | å†…å­˜   | å­˜å‚¨      | ç½‘ç»œ    |
| -------- | ----- | ------ | --------- | ------- |
| å‰ç«¯æœåŠ¡ | 1-2æ ¸ | 1-2GB  | 10GB      | 100Mbps |
| åç«¯æœåŠ¡ | 2-4æ ¸ | 4-8GB  | 20GB      | 1Gbps   |
| æ•°æ®åº“   | 4-8æ ¸ | 8-16GB | 100GB SSD | 1Gbps   |
| ç¼“å­˜æœåŠ¡ | 2-4æ ¸ | 4-8GB  | 20GB      | 1Gbps   |

### 12.3 å¾®æœåŠ¡æ¼”è¿›è·¯å¾„

**å½“å‰å•ä½“æ¶æ„ â†’ å¾®æœåŠ¡æ¶æ„ï¼š**

```mermaid
graph TB
    subgraph "Phase 1: å•ä½“åº”ç”¨"
        A[User Management App]
    end
    
    subgraph "Phase 2: æœåŠ¡æ‹†åˆ†"
        B[Auth Service]
        C[User Service]
        D[Email Service]
        E[Settings Service]
    end
    
    subgraph "Phase 3: å¾®æœåŠ¡ç”Ÿæ€"
        F[API Gateway]
        G[Service Discovery]
        H[Config Center]
        I[Message Queue]
    end
    
    A --> B
    A --> C
    A --> D
    A --> E
    
    B --> F
    C --> F
    D --> F
    E --> F
```

**æ‹†åˆ†åŸåˆ™ï¼š**

* æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†æœåŠ¡
* ä¿æŒæœåŠ¡çš„é«˜å†…èšä½è€¦åˆ
* ç‹¬ç«‹çš„æ•°æ®å­˜å‚¨
* å¼‚æ­¥é€šä¿¡ä¼˜å…ˆ
* ç»Ÿä¸€çš„æœåŠ¡æ²»ç†

## 13. å¼€å‘å’Œè¿ç»´è§„èŒƒ

### 13.1 ä»£ç è´¨é‡ä¿è¯

**ä»£ç è§„èŒƒï¼š**

* TypeScriptä¸¥æ ¼æ¨¡å¼
* ESLint + Prettierä»£ç æ ¼å¼åŒ–
* å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
* é›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒæµç¨‹
* ä»£ç å®¡æŸ¥ï¼ˆCode Reviewï¼‰

**CI/CDæµç¨‹ï¼š**

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm run test:cov
      - name: Run e2e tests
        run: npm run test:e2e
  
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Build Docker image
        run: docker build -t user-management .
      - name: Push to registry
        run: docker push user-management:latest
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to production
        run: kubectl apply -f k8s/
```

### 13.2 è¿ç»´è‡ªåŠ¨åŒ–

**åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰ï¼š**

* Terraformç®¡ç†äº‘èµ„æº
* Ansibleé…ç½®ç®¡ç†
* Kubernetes YAMLé…ç½®
* Helm ChartsåŒ…ç®¡ç†

**ç›‘æ§å‘Šè­¦è‡ªåŠ¨åŒ–ï¼š**

* Prometheus + Grafanaç›‘æ§
* AlertManagerå‘Šè­¦ç®¡ç†
* è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPA/VPAï¼‰
* æ—¥å¿—è‡ªåŠ¨åˆ†æå’Œå‘Šè­¦

### 13.3 å®‰å…¨è¿ç»´

**å®‰å…¨æ‰«æï¼š**

* ä¾èµ–æ¼æ´æ‰«æï¼ˆnpm auditï¼‰
* å®¹å™¨é•œåƒå®‰å…¨æ‰«æ
* ä»£ç å®‰å…¨æ‰«æï¼ˆSonarQubeï¼‰
* æ¸—é€æµ‹è¯•ï¼ˆå®šæœŸï¼‰

**è®¿é—®æ§åˆ¶ï¼š**

* æœ€å°æƒé™åŸåˆ™
* å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰
* å®¡è®¡æ—¥å¿—è®°å½•
* å®šæœŸæƒé™å®¡æŸ¥

## 14. æŠ€æœ¯å€ºåŠ¡å’Œä¼˜åŒ–è®¡åˆ’

### 14.1 å½“å‰æŠ€æœ¯å€ºåŠ¡

| ç±»åˆ«     | é—®é¢˜æè¿°         | å½±å“ç¨‹åº¦ | ä¼˜åŒ–è®¡åˆ’         |
| -------- | ---------------- | -------- | ---------------- |
| æ€§èƒ½     | æ•°æ®åº“æŸ¥è¯¢æœªä¼˜åŒ– | ä¸­ç­‰     | Q1ä¼˜åŒ–ç´¢å¼•å’ŒæŸ¥è¯¢ |
| å®‰å…¨     | å¯†ç ç­–ç•¥è¾ƒå¼±     | é«˜       | Q1å¢å¼ºå¯†ç å¤æ‚åº¦ |
| å¯ç»´æŠ¤æ€§ | éƒ¨åˆ†ä»£ç ç¼ºå°‘æµ‹è¯• | ä¸­ç­‰     | Q2æå‡æµ‹è¯•è¦†ç›–ç‡ |
| æ‰©å±•æ€§   | å•ä½“æ¶æ„é™åˆ¶     | ä½       | Q3-Q4å¾®æœåŠ¡æ”¹é€   |

### 14.2 æŠ€æœ¯æ¼”è¿›è·¯çº¿å›¾

**2024å¹´è·¯çº¿å›¾ï¼š**

* **Q1**: æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨åŠ å›º
* **Q2**: æµ‹è¯•å®Œå–„ã€ç›‘æ§å¢å¼º
* **Q3**: å¾®æœåŠ¡æ‹†åˆ†å‡†å¤‡
* **Q4**: å¾®æœåŠ¡æ¶æ„å®æ–½

**é•¿æœŸè§„åˆ’ï¼š**

* å¼•å…¥GraphQL API
* å®ç°äº‹ä»¶é©±åŠ¨æ¶æ„
* æœºå™¨å­¦ä¹ é›†æˆï¼ˆç”¨æˆ·è¡Œä¸ºåˆ†æï¼‰
* å¤šç§Ÿæˆ·æ”¯æŒ

---

## ğŸ“š å‚è€ƒèµ„æ–™

* [NestJSå®˜æ–¹æ–‡æ¡£](https://nestjs.com/)
* [TypeORMæ–‡æ¡£](https://typeorm.io/)
* [PostgreSQLæ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://www.postgresql.org/docs/)
* [Redisæœ€ä½³å®è·µ](https://redis.io/documentation)
* [JWTå®‰å…¨æœ€ä½³å®è·µ](https://tools.ietf.org/html/rfc7519)
* [Dockerå®¹å™¨åŒ–æœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/)
* [Kuberneteséƒ¨ç½²æŒ‡å—](https://kubernetes.io/docs/)

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv2.0*  
*æœ€åæ›´æ–°ï¼š2024å¹´1æœˆ*  
*ç»´æŠ¤è€…ï¼šå¼€å‘å›¢é˜Ÿ*
